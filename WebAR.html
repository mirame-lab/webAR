<!DOCTYPE html>
<html>
<title>AR MARKER GENERATOR</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/webAR/style.css">
<link rel='stylesheet' href='https://fonts.googleapis.com/icon?family=Material+Icons'>
<link rel='stylesheet' href='https://code.getmdl.io/1.3.0/material.indigo-pink.min.css'>
<script defer src='https://code.getmdl.io/1.3.0/material.min.js'></script>
<link href='https://fonts.googleapis.com/icon?family=Material+Icons' rel='stylesheet'>
<script src="/webAR/tracking.js-master/build/tracking-min.js"></script>
<!-- <script src="tracking.js-master/node_modules/dat.gui/build/dat.gui.min.js"></script> -->
<script src="/webAR/AR.js-master/three.js/examples/marker-training/threex-arpatternfile.js"> </script>
<script async src="/webAR/js/opencv.js" type="text/javascript"></script>


<style>
    

#marker_img img {
		width: 100%;
		max-width: 512px;
	}
</style>
<body>


<!-- Header -->
<header class="w3-container w3-theme w3-padding" id="myHeader">
  <i id="arcam" class=" fa fa-camera w3-xlarge w3-button w3-theme "  title="open AR Camera"></i> 
  <div class="w3-center">
  <h4>ASSIGNMENT 2</h4>
  <h1 class="w3-xxxlarge w3-animate-bottom">AR MARKER GENERATOR</h1>
    <div class="w3-padding-32">
      <input type="file"  accept="image/*" name="image" id="file" onchange="loadFile(event)" style="display: none;">
      <button class="w3-btn w3-xlarge w3-dark-grey w3-hover-light-grey" style="font-weight:900;"><label for="file" style="cursor: pointer;">UPLOAD</label></button>
      <button id="gen" class="w3-btn w3-xlarge w3-dark-grey w3-hover-light-grey" style="font-weight:900;" onclick="generate_feature()" disabled>GENERATE FEATURES</button>
    </div>
  </div>
</header>



<div class="w3-row-padding w3-center w3-margin-top">
<div class="w3-third">
  <div class="w3-card w3-container" style="min-height:460px">
  <h3>Image</h3><br>
  <img id="output" style="max-width :460px" /> 
  </div>
</div>

<div class="w3-third">
  <div class="w3-card w3-container" style="min-height:460px">
  <h3>Grayscale</h3><br>
  <canvas id="graycanv"  name="gray"></canvas>

  </div>
</div>

<div class="w3-third">
  <div class="w3-card w3-container" style="min-height:460px">
  <h3>Features</h3><br>
  <canvas id="canvas"  ></canvas>
  </div>
</div>
</div>

<div id="marker" style="display: none;">
    <h2 class="w3-center">Marker</h2>
    <div class="w3-content" style="max-width:800px;position:relative;">

    <!-- <img id="marker_img" class="mySlides w3-animate-opacity" style="width:100%"> -->
    <div class='mdl-grid'>

        <div class='mdl-cell mdl-cell--3-col'></div>
        <div class='mdl-cell mdl-cell--6-col'>
            <div id='marker_img'></div>
        </div>
        <div class='mdl-cell mdl-cell--3-col'></div>
    </div>
    
    <div style="justify-content: center" class='mdl-grid'>
        <div class='mdl-cell mdl-cell--12-col'>
        <label class="mdl-js-ripple-effect" for="patternRatioSlider">
            <span class="">Pattern Ratio 0.50</span>
            <input id='patternRatioSlider' class="mdl-slider mdl-js-slider" type="range" min="10" max="90" value="50" >
        </label>
        <div class='mdl-tooltip' for='patternRatioSlider'>
            Set size of inner image vs black border
        </div>
    </div>
</div>

<div style="justify-content: center" class='mdl-grid'>
    <div class='mdl-cell mdl-cell--12-col'>
        <label class="mdl-js-ripple-effect" for="imageSize">
            <span class="">Image size 512px</span>
            <input id='imageSize' class="mdl-slider mdl-js-slider" type="range" min="150" max="2500" value="512" >
        </label>
        <div class='mdl-tooltip' for='patternRatioSlider'>
            Set the pixel width/height of the image.
        </div>
    </div>
</div>

<div style="justify-content: center" class='mdl-grid'>
    <div class='mdl-cell mdl-cell--12-col'>
    <label class="mdl-js-ripple-effect" for="borderColor">
        <span class="">Border color. Please choose a dark one.</span>
        <input id='borderColor' type="text" value="black">
    </label>
    <div class='mdl-tooltip' for='borderColor'>
        Set the marker border color, using hexa code or color name.
    </div>
    <div class="w3-padding-32">
        <button id="download" class="w3-btn w3-xlarge w3-dark-grey w3-hover-light-grey" style="font-weight:900;">DOWNLOAD</button>
        <button id="patt" class="w3-btn w3-xlarge w3-dark-grey w3-hover-light-grey" style="font-weight:900;">DOWNLOAD PATTERN</button>
      </div>

</div>
</div>

</div>
</div>
<hr>

	<div class="spinner" id='spinner'></div>
    <div class="emscripten" id="status">Downloading...</div>
    <div class="emscripten">
      <progress value="0" max="100" id="progress" hidden=1></progress>
    </div>



<!-- Footer -->
<footer class="w3-container w3-theme-dark w3-padding-16">
  
  <p>Powered by <a href="https://www.w3schools.com/w3css/default.asp" target="_blank">w3.css</a></p>
  <div style="position:relative;bottom:55px;" class="w3-tooltip w3-right">
    <span class="w3-text w3-theme-light w3-padding">Go To Top</span>    
    <a class="w3-text-white" href="#myHeader"><span class="w3-xlarge">
    <i class="fa fa-chevron-circle-up"></i></span></a>
  </div>
  <p>Remember to check out our  <a href="w3css_references.asp" class="w3-btn w3-theme-light" target="_blank">W3.CSS Reference</a></p>
</footer>
<script src='dat.gui.js'></script>
<script async src="cv.js"></script>
<!-- Script for Sidebar, Tabs, Accordions, Progress bars and slideshows -->
<script>
    var fullMarkerURL = null;
    var innerImageURL = null;
    let dst = null; 

    document.getElementById("arcam").onclick = function () {
        location.href = "http://localhost/webAR/ARCam.html";
    };

//Upload
var loadFile = function(event) {
    let image = document.getElementById('output');
    var mark = document.getElementById('marker_img');

    image.src = URL.createObjectURL(event.target.files[0]);
    updateFullMarkerImage()

    //grayscale
    
    grayscale(image);
    document.getElementById("gen").disabled = false;
};

//////////////////////////////////to be replaced with OpenCV//////////////////////////////////////////

function grayscale(image){
  
image.onload = function() {
  
  let mat = cv.imread(image);
  dst = new cv.Mat();
  cv.cvtColor(mat, dst, cv.COLOR_RGBA2GRAY, 0);

  cv.imshow('graycanv', dst);
  mat.delete();

  // brisk_opencv(dst);
}
}

// function brisk_opencv(dst){
//  // Initiate STAR detector
//   var brisk = new cv.BRISK(30, 1, 3);

// // find the keypoints with ORB
// var kp = new cv.KeyPointVector();
// brisk.detect(dst,kp, new cv.Mat());

// // compute the descriptors with ORB
// var des = new cv.Mat();
// brisk.compute(dst, kp, des);

// // draw only keypoints location,not size and orientation
// var img2 = new cv.Mat();
// var color = new cv.Scalar(0,255,0);
// cv.drawKeypoints(dst, kp, img2, color, 0);
// show_image(img2, "canvas");

// kp.delete();
// color.delete();
// brisk.delete();
// des.delete();
// dst.delete();
// }
//Feature generator
function generate_feature(){

      
      var canvas = document.getElementById('canvas');
      
      var context = canvas.getContext('2d');
     
      var marker = document.getElementById('marker');
      var image = document.getElementById('output');
      var width = image.clientWidth;
      var height = image.clientHeight;
      console.log(height + " " + width);
      
      canvas.width = width;
      canvas.height = height;
      window.fastThreshold = 10;

      
      var doFindFeatures = function() {
        tracking.Fast.THRESHOLD = window.fastThreshold;
        context.drawImage(image, 0, 0, width, height);

        var imageData = context.getImageData(0, 0, width, height);
        var gray = tracking.Image.grayscale(imageData.data, width, height);

        var corners = tracking.Fast.findCorners(gray, width, height);

        for (var i = 0; i < corners.length; i += 2) {
          context.fillStyle = '#f00';
          context.fillRect(corners[i], corners[i + 1], 3, 3);
        }
      };

      doFindFeatures();

      marker.style.display = "block";

      //not working
      // var gui = new dat.GUI();
      // gui.add(window, 'fastThreshold', 0, 100).onChange(doFindFeatures);
}

//////////////////////////////////to be replaced with OpenCV//////////////////////////////////////////


//generate and download pattern
    document.querySelector('#patt').addEventListener('click', function(){

		console.assert(innerImageURL)
		THREEx.ArPatternFile.encodeImageURL(innerImageURL, function onComplete(patternFileString){
			THREEx.ArPatternFile.triggerDownload(patternFileString, "pattern-" + "marker" + ".patt")
		})
	})

    document.querySelector('#download').addEventListener('click', function(){

		// tech from https://stackoverflow.com/questions/3665115/create-a-file-in-memory-for-user-to-download-not-through-server
        var domElement = window.document.createElement('a');
        console.log(fullMarkerURL); //test if change
		domElement.href = fullMarkerURL;
		domElement.download = "pattern-" + 'marker' + '.png';
		document.body.appendChild(domElement)
		domElement.click();
		document.body.removeChild(domElement)
    })
    
    document.querySelector('#patternRatioSlider').addEventListener('input', function(){
		// update the patternRatio number
		var patternRatio = document.querySelector('#patternRatioSlider').value/100
		var domElement = document.querySelector('[for=patternRatioSlider] span')
		domElement.innerHTML = `Pattern Ratio ${patternRatio.toFixed(2)}`

		// update fullMarkerImage
		updateFullMarkerImage()
	})

	document.querySelector('#imageSize').addEventListener('input', function(){
		// update the patternRatio number
		var imageSize = document.querySelector('#imageSize').value
		var domElement = document.querySelector('[for=imageSize] span')
		domElement.innerHTML = `Image size ${imageSize}px`

		// update fullMarkerImage
		updateFullMarkerImage()
	})

	document.querySelector('#borderColor').addEventListener('input', function(){
		var imageSize = document.querySelector('#borderColor').value
		var domElement = document.querySelector('[for=borderColor] span')

		// update fullMarkerImage
		updateFullMarkerImage()
	})


function updateFullMarkerImage(){
        innerImageURL = document.getElementById('output').src;
		// get patternRatio
		var patternRatio = document.querySelector('#patternRatioSlider').value/100
		var imageSize = document.querySelector('#imageSize').value
		var borderColor = document.querySelector('#borderColor').value

		function hexaColor(color) {
			return /^#[0-9A-F]{6}$/i.test(color);
		};

		var s = new Option().style;
		s.color = borderColor;
  		if (borderColor === '' || (s.color != borderColor && !hexaColor(borderColor))) {
			// if color not valid, use black
			borderColor = 'black';
		}

		THREEx.ArPatternFile.buildFullMarker(innerImageURL, patternRatio, imageSize, borderColor, function onComplete(markerUrl){
			fullMarkerURL = markerUrl

			var fullMarkerImage = document.createElement('img')
			fullMarkerImage.src = fullMarkerURL

			// put fullMarkerImage into #imageContainer
			var container = document.querySelector('#marker_img')
			while (container.firstChild) container.removeChild(container.firstChild);
			container.appendChild(fullMarkerImage)
		})
	}


// Side navigation
function w3_open() {
  var x = document.getElementById("mySidebar");
  x.style.width = "100%";
  x.style.fontSize = "40px";
  x.style.paddingTop = "10%";
  x.style.display = "block";
}
function w3_close() {
  document.getElementById("mySidebar").style.display = "none";
}



// Accordions
function myAccFunc(id) {
  var x = document.getElementById(id);
  if (x.className.indexOf("w3-show") == -1) {
    x.className += " w3-show";
  } else { 
    x.className = x.className.replace(" w3-show", "");
  }
}

// Slideshows
var slideIndex = 1;

function plusDivs(n) {
  slideIndex = slideIndex + n;
  showDivs(slideIndex);
}


</script>
	<script  type='text/javascript'>

	function getCV(){

		var zip ;
		var oReq = new XMLHttpRequest();
		oReq.open("GET", "/opencvjs/examples/cv.js.gz", "application/x-gzip");
		oReq.responseType = "arraybuffer";

		oReq.onload = function (oEvent) {
		  var arrayBuffer = oReq.response; // Note: not oReq.responseText
		  if (arrayBuffer) {
				zip = new Uint8Array(arrayBuffer);
				console.log("decompressing script");
				var decompressed = Zee.decompress(zip);
				console.log("script decompressed");
				var head= document.getElementsByTagName('head')[0];
				var script= document.createElement('script');
				script.type= 'text/javascript';
				var length = decompressed.length ;
				decoder = new TextDecoder();
				script.text = decoder.decode(decompressed);
				head.appendChild(script);
				console.log("script added");
		  }
		};
		oReq.send(null);
	}
	var statusElement = document.getElementById('status');
	var progressElement = document.getElementById('progress');
	var spinnerElement = document.getElementById('spinner');
	var Module = {
	preRun: [],
	postRun: [],
	print: (function() {
	  var element = document.getElementById('output');
	  if (element) element.value = ''; // clear browser cache
	  return function(text) {
	    text = Array.prototype.slice.call(arguments).join(' ');
	    // These replacements are necessary if you render to raw HTML
	    //text = text.replace(/&/g, "&amp;");
	    //text = text.replace(/</g, "&lt;");
	    //text = text.replace(/>/g, "&gt;");
	    //text = text.replace('\n', '<br>', 'g');
	    console.log(text);
	    if (element) {
	      element.value += text + "\n";
	      element.scrollTop = element.scrollHeight; // focus on bottom
	    }
	  };
	})(),
	printErr: function(text) {
	  text = Array.prototype.slice.call(arguments).join(' ');
	  if (0) { // XXX disabled for safety typeof dump == 'function') {
	    dump(text + '\n'); // fast, straight to the real console
	  } else {
	    console.error(text);
	  }
	},
	canvas: (function() {
	  var canvas = document.getElementById('resCanvas');
	  return canvas;
	})(),
	setStatus: function(text) {
	  if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
	  if (text === Module.setStatus.text) return;
	  var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
	  var now = Date.now();
	  if (m && now - Date.now() < 30) return; // if this is a progress update, skip it if too soon
	  if (m) {
	    text = m[1];
	    progressElement.value = parseInt(m[2])*100;
	    progressElement.max = parseInt(m[4])*100;
	    progressElement.hidden = false;
	    spinnerElement.hidden = false;
	  } else {
	    progressElement.value = null;
	    progressElement.max = null;
	    progressElement.hidden = true;
	    if (!text) spinnerElement.style.display = 'none';
	  }
	  statusElement.innerHTML = text;
	},
	totalDependencies: 0,
		monitorRunDependencies: function(left) {
		  this.totalDependencies = Math.max(this.totalDependencies, left);
		  Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
		}
	};
	Module.setStatus('Downloading...');
		window.onerror = function(event) {
		// TODO: do not warn on ok events like simulating an infinite loop or exitStatus
		Module.setStatus('Exception thrown, see JavaScript console');
		spinnerElement.style.display = 'none';
		Module.setStatus = function(text) {
		  if (text) Module.printErr('[post-exception status] ' + text);
		};
	};
    </script>
</body>
</html>
